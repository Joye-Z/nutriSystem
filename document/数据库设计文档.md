# 健康食谱管理与膳食规划系统
## 数据库设计文档

## 1. 文档概述

### 1.1 文档目的
本文档旨在详细说明健康食谱管理与膳食规划系统的数据库设计方案，包括数据需求分析、概念模型设计、逻辑模型设计、物理模型设计、约束与安全设计、性能优化设计以及实施与维护计划等内容，为系统的数据库开发、部署和维护提供指导。

### 1.2 术语定义
| 术语 | 解释 |
|------|------|
| 食谱 | 包含食材、烹饪步骤、营养信息等的完整烹饪指南 |
| 膳食计划 | 用户根据个人需求制定的每日/每周餐饮安排 |
| BMI | 体重指数，用于评估人体体重与身高的比例是否健康 |
| BMR | 基础代谢率，维持身体基本功能所需的最低能量消耗 |
| TDEE | 总能量消耗，包括基础代谢、活动消耗等在内的每日总能量消耗 |
| ER图 | 实体关系图，用于描述数据库中实体及其之间关系的图形化工具 |
| 主键 | 唯一标识表中记录的字段或字段组合 |
| 外键 | 用于建立表与表之间关联的字段 |

## 2. 数据库需求分析

### 2.1 数据需求

#### 2.1.1 用户数据
| 数据项 | 描述 | 数据类型 | 约束 |
|--------|------|----------|------|
| 用户基本信息 | 用户名、密码、真实姓名、头像、角色、手机号、邮箱 | 字符串 | 用户名唯一，密码必填 |
| 用户健康数据 | 身高、体重、年龄、性别、活动水平、健康目标 | 数值/字符串 | 可选填 |
| 管理员信息 | 管理员账号、密码、名称、头像、角色 | 字符串 | 用户名唯一 |

#### 2.1.2 食谱数据
| 数据项 | 描述 | 数据类型 | 约束 |
|--------|------|----------|------|
| 食谱基本信息 | 食谱名称、描述、烹饪时间、难度、分类、图片 | 字符串/数值 | 名称必填 |
| 食谱内容 | 食材清单、烹饪步骤 | 文本 | 必填 |
| 营养信息 | 热量、蛋白质、碳水化合物、脂肪 | 数值 | 必填 |

#### 2.1.3 膳食计划数据
| 数据项 | 描述 | 数据类型 | 约束 |
|--------|------|----------|------|
| 计划基本信息 | 计划名称、计划日期、餐次类型、用户ID | 字符串/日期/数值 | 用户ID必填，计划日期必填 |
| 餐食内容 | 关联食谱ID、自定义餐食内容、热量、备注 | 数值/文本 | 食谱ID或自定义餐食内容必填其一 |

### 2.2 业务规则

#### 2.2.1 用户管理规则
- 每个用户必须有唯一的用户名
- 用户密码必须进行加密存储
- 用户可以录入和修改个人健康数据
- 系统需要根据用户健康数据计算BMI、BMR和TDEE等指标

#### 2.2.2 食谱管理规则
- 每个食谱必须有唯一的ID标识
- 食谱必须包含名称、食材清单、烹饪步骤和营养信息
- 食谱可以按分类、难度等进行筛选和查询
- 管理员可以添加、修改和删除食谱

#### 2.2.3 膳食计划规则
- 每个膳食计划必须关联到特定用户
- 膳食计划必须指定计划日期和餐次类型
- 膳食计划可以关联系统食谱或设置自定义餐食
- 用户可以查看、创建、修改和删除自己的膳食计划

### 2.3 数据量预估

| 数据类别 | 预估记录数/年 | 存储需求/年 | 增长趋势 |
|----------|---------------|-------------|----------|
| 用户数据 | 10,000条 | 约5MB | 稳定增长 |
| 管理员数据 | 50条 | 约10KB | 缓慢增长 |
| 食谱数据 | 5,000条 | 约50MB | 稳步增长 |
| 膳食计划数据 | 约3,650,000条(按每用户每天3条) | 约300MB | 快速增长 |
| 总计 | - | 约355MB | 中速增长 |

## 3. 概念模型设计

### 3.1 实体关系图(ER图)

  ```mermaid
  erDiagram
    USER ||--o{ MEAL_PLAN : creates
    ADMIN ||--o{ RECIPE : manages
    RECIPE ||--o{ MEAL_PLAN : includes
    
    USER {
        INT id PK
        VARCHAR username
        VARCHAR password
        VARCHAR name
        VARCHAR avatar
        VARCHAR role
        VARCHAR phone
        VARCHAR email
        DOUBLE height
        DOUBLE weight
        INT age
        VARCHAR gender
        VARCHAR activity_level
        VARCHAR goal
    }
    
    ADMIN {
        INT id PK
        VARCHAR username
        VARCHAR password
        VARCHAR name
        VARCHAR avatar
        VARCHAR role
    }
    
    RECIPE {
        INT id PK
        VARCHAR name
        TEXT ingredients
        TEXT steps
        INT cooking_time
        INT calories
        DECIMAL protein
        DECIMAL carbohydrate
        DECIMAL fat
        VARCHAR category
        VARCHAR difficulty
        VARCHAR image
    }
    
    MEAL_PLAN {
        INT id PK
        INT user_id FK
        VARCHAR plan_name
        DATE plan_date
        VARCHAR meal_type
        INT recipe_id FK
        TEXT custom_meal
        INT calories
        TEXT notes
    }
  ```

### 3.2 实体关系说明

#### 3.2.1 用户(USER)与膳食计划(MEAL_PLAN)关系
- **关系类型**：一对多(1:N)
- **描述**：一个用户可以创建多个膳食计划，但每个膳食计划只能属于一个用户
- **关联方式**：通过MEAL_PLAN表中的user_id字段关联到USER表的id字段
- **约束**：当用户被删除时，其对应的所有膳食计划也应该被级联删除

#### 3.2.2 管理员(ADMIN)与食谱(RECIPE)关系
- **关系类型**：一对多(1:N)
- **描述**：一个管理员可以管理多个食谱，但每个食谱只能被一个管理员创建或修改
- **关联方式**：通过RECIPE表的创建者信息关联到ADMIN表（系统实现层面）
- **约束**：管理员账号仅用于系统管理操作，不直接体现在表的外键关系中

#### 3.2.3 食谱(RECIPE)与膳食计划(MEAL_PLAN)关系
- **关系类型**：一对多(1:N)
- **描述**：一个食谱可以被多个膳食计划引用，但每个膳食计划最多引用一个食谱
- **关联方式**：通过MEAL_PLAN表中的recipe_id字段关联到RECIPE表的id字段
- **约束**：当食谱被删除时，引用该食谱的膳食计划不应被级联删除，而应该将recipe_id字段设置为NULL或保留历史数据

### 3.3 实体属性说明

#### 3.3.1 用户实体(USER)
- **id**：用户唯一标识符，主键
- **username**：用户名，系统登录标识，唯一
- **password**：用户密码，加密存储
- **name**：用户真实姓名
- **avatar**：用户头像URL
- **role**：用户角色标识
- **phone**：手机号码
- **email**：电子邮箱
- **height**：身高(厘米)
- **weight**：体重(公斤)
- **age**：年龄
- **gender**：性别
- **activity_level**：活动水平
- **goal**：健康目标

#### 3.3.2 管理员实体(ADMIN)
- **id**：管理员唯一标识符，主键
- **username**：管理员用户名，唯一
- **password**：管理员密码，加密存储
- **name**：管理员名称
- **avatar**：管理员头像URL
- **role**：管理员角色标识

#### 3.3.3 食谱实体(RECIPE)
- **id**：食谱唯一标识符，主键
- **name**：食谱名称
- **ingredients**：食材清单，JSON格式存储
- **steps**：烹饪步骤，JSON格式存储
- **cooking_time**：烹饪时间(分钟)
- **calories**：热量(卡路里)
- **protein**：蛋白质含量(克)
- **carbohydrate**：碳水化合物含量(克)
- **fat**：脂肪含量(克)
- **category**：食谱分类
- **difficulty**：烹饪难度
- **image**：食谱图片URL

#### 3.3.4 膳食计划实体(MEAL_PLAN)
- **id**：膳食计划唯一标识符，主键
- **user_id**：关联的用户ID，外键
- **plan_name**：计划名称
- **plan_date**：计划日期
- **meal_type**：餐次类型(早餐、午餐、晚餐、加餐)
- **recipe_id**：关联的食谱ID，外键(可选)
- **custom_meal**：自定义餐食内容
- **calories**：热量(卡路里)
- **notes**：备注信息

## 4. 逻辑模型设计

### 4.1 表结构设计

#### 4.1.1 用户表(user)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| `id` | `INT` | `PRIMARY KEY AUTO_INCREMENT` | 用户ID |
| `username` | `VARCHAR(255)` | `UNIQUE` | 用户名 |
| `password` | `VARCHAR(255)` | | 密码(加密存储) |
| `name` | `VARCHAR(255)` | | 真实姓名 |
| `avatar` | `VARCHAR(255)` | | 头像URL |
| `role` | `VARCHAR(255)` | | 用户角色 |
| `phone` | `VARCHAR(255)` | | 手机号 |
| `email` | `VARCHAR(255)` | | 邮箱 |
| `height` | `DECIMAL(10,2)` | | 身高(cm) |
| `weight` | `DECIMAL(10,2)` | | 体重(kg) |
| `age` | `INT` | | 年龄 |
| `gender` | `VARCHAR(20)` | | 性别 |
| `activity_level` | `VARCHAR(50)` | | 活动水平 |
| `goal` | `VARCHAR(50)` | | 健康目标 |

#### 4.1.2 管理员表(admin)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| `id` | `INT` | `PRIMARY KEY AUTO_INCREMENT` | 管理员ID |
| `username` | `VARCHAR(255)` | `UNIQUE` | 管理员用户名 |
| `password` | `VARCHAR(255)` | | 密码(加密存储) |
| `name` | `VARCHAR(255)` | | 管理员名称 |
| `avatar` | `VARCHAR(255)` | | 头像URL |
| `role` | `VARCHAR(255)` | | 管理员角色 |

#### 4.1.3 食谱表(recipe)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| `id` | `INT` | `PRIMARY KEY AUTO_INCREMENT` | 食谱ID |
| `name` | `VARCHAR(255)` | | 食谱名称 |
| `description` | `TEXT` | | 食谱描述 |
| `ingredients` | `TEXT` | | 食材清单 |
| `steps` | `TEXT` | | 烹饪步骤 |
| `cooking_time` | `INT` | | 烹饪时间(分钟) |
| `calories` | `INT` | | 热量(卡路里) |
| `protein` | `DECIMAL(10,2)` | | 蛋白质(g) |
| `carbohydrate` | `DECIMAL(10,2)` | | 碳水化合物(g) |
| `fat` | `DECIMAL(10,2)` | | 脂肪(g) |
| `category` | `VARCHAR(100)` | | 分类 |
| `difficulty` | `VARCHAR(50)` | | 难度 |
| `image` | `VARCHAR(500)` | | 食谱图片URL |
| `create_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `update_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

#### 4.1.4 膳食计划表(meal_plan)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| `id` | `INT` | `PRIMARY KEY AUTO_INCREMENT` | 膳食计划ID |
| `user_id` | `INT` | `NOT NULL, FOREIGN KEY REFERENCES user(id)` | 用户ID |
| `plan_name` | `VARCHAR(255)` | | 计划名称 |
| `plan_date` | `DATE` | `NOT NULL` | 计划日期 |
| `meal_type` | `VARCHAR(50)` | `NOT NULL` | 餐次类型(早餐/午餐/晚餐/加餐) |
| `recipe_id` | `INT` | `FOREIGN KEY REFERENCES recipe(id)` | 食谱ID(可选) |
| `custom_meal` | `TEXT` | | 自定义餐食内容 |
| `calories` | `INT` | | 热量(卡路里) |
| `notes` | `TEXT` | | 备注 |
| `create_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `update_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

### 4.2 主外键设计

#### 4.2.1 主键设计

| 表名 | 主键字段 | 主键类型 | 描述 |
|------|----------|----------|------|
| `user` | `id` | `INT AUTO_INCREMENT` | 用户唯一标识符，自增主键 |
| `admin` | `id` | `INT AUTO_INCREMENT` | 管理员唯一标识符，自增主键 |
| `recipe` | `id` | `INT AUTO_INCREMENT` | 食谱唯一标识符，自增主键 |
| `meal_plan` | `id` | `INT AUTO_INCREMENT` | 膳食计划唯一标识符，自增主键 |

#### 4.2.2 外键设计

| 外键名称 | 所在表 | 外键字段 | 参考表 | 参考字段 | 约束条件 |
|----------|--------|----------|--------|----------|----------|
| `fk_meal_plan_user` | `meal_plan` | `user_id` | `user` | `id` | `ON DELETE CASCADE ON UPDATE CASCADE` |
| `fk_meal_plan_recipe` | `meal_plan` | `recipe_id` | `recipe` | `id` | `ON DELETE SET NULL ON UPDATE CASCADE` |

### 4.3 关系设计

#### 4.3.1 实体关系矩阵

| 实体 | 用户 | 管理员 | 食谱 | 膳食计划 |
|------|------|--------|------|----------|
| 用户 | 1:1 | 无 | 无 | 1:N |
| 管理员 | 无 | 1:1 | 1:N | 无 |
| 食谱 | 无 | 无 | 1:1 | 1:N |
| 膳食计划 | N:1 | 无 | N:1 | 1:1 |

#### 4.3.2 关系约束说明

1. **用户与膳食计划关系约束**
   - 外键约束：`meal_plan.user_id` 必须存在于 `user.id` 中
   - 级联删除：当用户被删除时，其所有膳食计划也被删除
   - 级联更新：当用户ID更新时，相关膳食计划的用户ID也更新

2. **食谱与膳食计划关系约束**
   - 外键约束：`meal_plan.recipe_id` 必须存在于 `recipe.id` 中或为NULL
   - 空值处理：当食谱被删除时，相关膳食计划的recipe_id设置为NULL
   - 级联更新：当食谱ID更新时，相关膳食计划的食谱ID也更新

### 4.4 索引设计

#### 4.4.1 唯一索引

| 索引名称 | 所在表 | 索引字段 | 描述 |
|----------|--------|----------|------|
| `username` | `user` | `username` | 确保用户名唯一性，加速登录查询 |
| `username` | `admin` | `username` | 确保管理员用户名唯一性 |

#### 4.4.2 普通索引

| 索引名称 | 所在表 | 索引字段 | 描述 |
|----------|--------|----------|------|
| `idx_user_date` | `meal_plan` | `user_id, plan_date` | 加速按用户和日期查询膳食计划 |
| `idx_recipe` | `meal_plan` | `recipe_id` | 加速按食谱查询膳食计划 |

## 5. 物理模型设计

### 5.1 数据库基础配置

- **数据库类型**：MySQL 8.0
- **存储引擎**：默认使用InnoDB引擎
- **字符集**：UTF-8（utf8mb4）
- **排序规则**：utf8mb4_general_ci

### 5.2 表结构实现

所有表结构直接在MySQL数据库中创建，使用默认的数据库配置。表结构定义见前面的逻辑模型设计部分。

### 5.3 索引策略

- 每个表都设置自增主键ID
- 在常用查询条件的列上创建索引，如用户名、食谱名称等
- 使用外键约束维护表之间的关系

## 6. 数据库约束与安全设计

### 6.1 完整性约束

#### 6.1.1 主键约束

| 表名 | 主键列 | 约束名称 | 约束描述 |
| :--- | :--- | :--- | :--- |
| user | id | pk_user | 唯一标识用户记录 |
| admin | id | pk_admin | 唯一标识管理员记录 |
| recipe | id | pk_recipe | 唯一标识食谱记录 |
| meal_plan | id | pk_meal_plan | 唯一标识膳食计划记录 |

#### 6.1.2 外键约束

| 表名 | 外键列 | 引用表 | 引用列 | 约束名称 | 约束描述 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| meal_plan | user_id | user | id | fk_meal_plan_user | 关联用户表 |
| meal_plan | recipe_id | recipe | id | fk_meal_plan_recipe | 关联食谱表 |

#### 6.1.3 唯一性约束

| 表名 | 列名 | 约束名称 | 约束描述 |
| :--- | :--- | :--- | :--- |
| user | username | uk_user_username | 用户名唯一 |
| user | email | uk_user_email | 邮箱地址唯一 |
| admin | username | uk_admin_username | 管理员用户名唯一 |
| recipe | title | uk_recipe_title | 食谱标题唯一 |

#### 6.1.4 非空约束

| 表名 | 列名 | 约束描述 |
| :--- | :--- | :--- |
| meal_plan | user_id | 用户ID不能为空 |
| meal_plan | plan_date | 计划日期不能为空 |
| meal_plan | meal_type | 餐别类型不能为空 |

#### 6.1.5 检查约束

> 注意：当前系统未实现检查约束，数据验证在应用层面进行。

### 6.2 数据安全

#### 6.2.1 用户权限管理

```sql
-- 创建数据库用户
CREATE USER 'health_app'@'%' IDENTIFIED BY 'StrongPassword!2024';
CREATE USER 'health_admin'@'%' IDENTIFIED BY 'StrongAdminPassword!2024';

-- 分配权限
GRANT SELECT, INSERT, UPDATE, DELETE ON health_system.* TO 'health_app'@'%';
GRANT ALL PRIVILEGES ON health_system.* TO 'health_admin'@'%';

-- 回收权限
REVOKE DELETE ON health_system.user FROM 'health_app'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

#### 6.2.2 密码加密策略

```sql
-- 使用MD5加盐加密密码示例
-- 应用层面实现，数据库中存储加密后的密码
ALTER TABLE user MODIFY COLUMN password VARCHAR(255) NOT NULL;
ALTER TABLE admin MODIFY COLUMN password VARCHAR(255) NOT NULL;
```

> 注意：系统实际使用MD5加盐的方式进行密码加密存储

#### 6.2.3 SQL注入防护

- 使用参数化查询和预处理语句
- 避免直接拼接SQL语句
- 对用户输入进行严格验证和过滤
- 使用最小权限原则配置数据库用户

### 6.3 数据备份

- 建议定期对数据库进行手动备份
- 备份命令示例：`mysqldump -u root -p health_system > health_system_backup_YYYYMMDD.sql`
- 备份文件应存储在安全位置

### 6.4 数据库使用注意事项

> 注意：系统未配置数据库审计功能，建议在生产环境中根据需要配置相关审计机制。

### 6.5 安全最佳实践

- 定期更新数据库版本和补丁
- 禁用不必要的数据库功能和插件
- 使用SSL/TLS加密数据库连接
- 实施数据库防火墙
- 定期进行安全扫描和渗透测试
- 限制数据库访问IP
- 实施数据库敏感数据脱敏

### 6.6 数据安全注意事项

> 注意：在应用层实现敏感数据的保护，确保用户密码加密存储，敏感信息在展示时进行适当脱敏。

## 7. 数据库使用注意事项

### 7.1 查询优化

> 注意：当前系统数据库性能优化主要通过合理的索引设计实现，实际部署时应根据数据量和访问模式进行针对性优化。

```sql
-- 建议创建的索引
SHOW INDEX FROM meal_plan;

-- 执行慢查询时可使用EXPLAIN分析
EXPLAIN SELECT * FROM meal_plan WHERE user_id = 1 AND plan_date = '2024-05-20';
        
```

### 7.2 数据库碎片整理

#### 7.2.1 定期优化表

```sql
-- 优化表，回收空间并整理数据文件
OPTIMIZE TABLE user;
OPTIMIZE TABLE recipe;
OPTIMIZE TABLE meal_plan;

-- 分析表，更新统计信息
ANALYZE TABLE user;
ANALYZE TABLE recipe;
ANALYZE TABLE meal_plan;
```

#### 7.2.2 碎片整理计划

- 定期执行：每周或每月一次
- 执行时间：低峰期
- 监控效果：优化前后比较表大小和查询性能

### 7.3 大数据量处理策略

#### 7.3.1 数据归档

```sql
-- 归档旧数据到历史表
CREATE TABLE meal_plan_history LIKE meal_plan;

INSERT INTO meal_plan_history 
SELECT * FROM meal_plan 
WHERE plan_date < DATE_SUB(CURRENT_DATE(), INTERVAL 1 YEAR);

-- 删除归档后的数据
DELETE FROM meal_plan 
WHERE plan_date < DATE_SUB(CURRENT_DATE(), INTERVAL 1 YEAR);

-- 重建索引
ALTER TABLE meal_plan REBUILD;
```

#### 7.3.2 数据压缩

```sql
-- 启用表压缩
ALTER TABLE recipe ROW_FORMAT=COMPRESSED KEY_BLOCK_SIZE=8;
```

### 7.4 性能优化检查表

- [ ] 所有常用查询都有适当的索引
- [ ] 避免SELECT *查询
- [ ] 定期分析和优化慢查询
- [ ] 合理配置连接池参数
- [ ] 监控数据库性能指标
- [ ] 定期执行碎片整理
- [ ] 为大数据量表实施分区或分表
- [ ] 使用缓存减少数据库负载
- [ ] 优化JOIN查询，避免笛卡尔积
- [ ] 定期更新统计信息

## 8. 数据库实施与维护计划

### 8.1 数据库安装与配置

#### 8.1.1 安装步骤

```bash
# Ubuntu系统安装MySQL 8.0
apt update
apt install -y mysql-server

# 安全配置
mysql_secure_installation

# 启动并设置开机自启
systemctl enable mysql
systemctl start mysql

# 验证安装
mysql -V
```

#### 8.1.2 配置文件优化

```ini
# my.cnf 完整配置
[mysqld]
# 基础设置
port = 3306
bind-address = 0.0.0.0

# 数据库文件位置
datadir = /var/lib/mysql
socket = /var/run/mysqld/mysqld.sock

# 字符集设置
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# 内存配置
innodb_buffer_pool_size = 4G
key_buffer_size = 256M
max_connections = 500
thread_cache_size = 64

# 并发和I/O配置
innodb_thread_concurrency = 0
innodb_flush_log_at_trx_commit = 1
innodb_flush_method = O_DIRECT
innodb_io_capacity = 2000
innodb_io_capacity_max = 4000

# 查询优化
sort_buffer_size = 2M
read_buffer_size = 2M
read_rnd_buffer_size = 4M
join_buffer_size = 2M

# 日志设置
slow_query_log = ON
long_query_time = 2
slow_query_log_file = /var/log/mysql/slow.log
general_log = OFF
log_error = /var/log/mysql/error.log

# 二进制日志(用于增量备份和主从复制)
log_bin = /var/lib/mysql/mysql-bin
expire_logs_days = 7
max_binlog_size = 100M

# 表空间设置
innodb_file_per_table = 1
innodb_data_file_path = ibdata1:12M:autoextend

# 其他设置
skip_name_resolve = ON
table_definition_cache = 2000
table_open_cache = 4000
max_connect_errors = 1000000
```

### 8.2 数据库初始化

#### 8.2.1 创建数据库和用户

```sql
-- 创建数据库
CREATE DATABASE health_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建应用用户
CREATE USER 'health_app'@'%' IDENTIFIED BY 'StrongPassword!2024';
CREATE USER 'health_admin'@'%' IDENTIFIED BY 'StrongAdminPassword!2024';

-- 分配权限
GRANT SELECT, INSERT, UPDATE, DELETE ON health_system.* TO 'health_app'@'%';
GRANT ALL PRIVILEGES ON health_system.* TO 'health_admin'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

#### 8.2.2 创建表结构

```sql
-- 创建用户表
CREATE TABLE health_system.user (
    id INT NOT NULL AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    address VARCHAR(200),
    age INT,
    gender VARCHAR(10),
    health_goal VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    UNIQUE INDEX idx_user_username (username),
    UNIQUE INDEX idx_user_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建管理员表
CREATE TABLE health_system.admin (
    id INT NOT NULL AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(100) NOT NULL,
    role VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    UNIQUE INDEX idx_admin_username (username)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建食谱表
CREATE TABLE health_system.recipe (
    id INT NOT NULL AUTO_INCREMENT,
    title VARCHAR(100) NOT NULL,
    description TEXT NOT NULL,
    ingredients TEXT NOT NULL,
    instructions TEXT NOT NULL,
    prep_time INT NOT NULL,
    cook_time INT NOT NULL,
    servings INT NOT NULL,
    calories INT NOT NULL,
    category VARCHAR(50) NOT NULL,
    difficulty VARCHAR(20) NOT NULL,
    image_url VARCHAR(255),
    admin_id INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    UNIQUE INDEX idx_recipe_title (title),
    INDEX idx_recipe_category (category),
    INDEX idx_recipe_admin (admin_id),
    FULLTEXT INDEX idx_recipe_description (description),
    CONSTRAINT fk_recipe_admin FOREIGN KEY (admin_id) REFERENCES admin(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建膳食计划表
CREATE TABLE health_system.meal_plan (
    id INT NOT NULL AUTO_INCREMENT,
    user_id INT NOT NULL,
    recipe_id INT NOT NULL,
    plan_date DATE NOT NULL,
    meal_type VARCHAR(20) NOT NULL,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    INDEX idx_meal_plan_user_date (user_id, plan_date),
    INDEX idx_meal_plan_recipe (recipe_id),
    CONSTRAINT fk_meal_plan_user FOREIGN KEY (user_id) REFERENCES user(id),
    CONSTRAINT fk_meal_plan_recipe FOREIGN KEY (recipe_id) REFERENCES recipe(id),
    CONSTRAINT chk_meal_type CHECK (meal_type IN ('breakfast', 'lunch', 'dinner', 'snack'))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 8.2.3 初始数据导入

```sql
-- 插入初始管理员数据
INSERT INTO health_system.admin (username, password, email, role) 
VALUES ('admin', '$2a$10$e8Yj5w0uM9e2cQp3z7K3nOe7ZJ1X5rP8B9L7H6G5F3D2S1A4V9N6', 'admin@healthsystem.com', '超级管理员');

-- 插入示例食谱数据
INSERT INTO health_system.recipe (title, description, ingredients, instructions, prep_time, cook_time, servings, calories, category, difficulty, image_url, admin_id) 
VALUES ('健康蔬菜沙拉', '营养均衡的蔬菜沙拉，富含维生素和纤维素', '生菜100g, 黄瓜50g, 番茄50g, 橄榄油10ml, 柠檬汁5ml, 盐少许', '1. 将生菜洗净撕成小块
2. 黄瓜切片，番茄切块
3. 加入橄榄油和柠檬汁搅拌均匀
4. 撒上少许盐调味即可', 5, 0, 1, 150, '健康食谱', '简单', 'https://example.com/salad.jpg', 1);
```

### 8.3 数据库迁移策略

#### 8.3.1 数据库版本管理

```xml
<!-- 使用Flyway进行数据库版本管理 -->
<!-- pom.xml依赖配置 -->
<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-core</artifactId>
    <version>9.16.3</version>
</dependency>
```

#### 8.3.2 迁移脚本示例

```sql
-- V1__Create_Tables.sql
CREATE TABLE user (...);
CREATE TABLE admin (...);
CREATE TABLE recipe (...);
CREATE TABLE meal_plan (...);

-- V2__Add_Indexes.sql
CREATE INDEX idx_recipe_category ON recipe(category);
CREATE INDEX idx_meal_plan_user_date ON meal_plan(user_id, plan_date);

-- V3__Add_New_Field.sql
ALTER TABLE user ADD COLUMN last_login TIMESTAMP;
```

#### 8.3.3 迁移执行流程

```bash
# 使用Flyway命令行工具执行迁移
flyway -url=jdbc:mysql://localhost:3306/health_system \
       -user=health_admin \
       -password=StrongAdminPassword!2024 \
       -locations=filesystem:migrations \
       migrate
```

### 8.4 日常维护计划

#### 8.4.1 每日维护任务

```bash
#!/bin/bash
# daily_maintenance.sh

# 1. 备份二进制日志
mysqladmin -u root -p$MYSQL_ROOT_PASSWORD flush-logs

# 2. 检查数据库连接状态
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "SHOW STATUS LIKE 'Threads_connected';"

# 3. 清理过期会话
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "KILL IDENTIFIED BY '';"

# 4. 检查慢查询日志
if [ -s /var/log/mysql/slow.log ]; then
    echo "发现慢查询，请检查: /var/log/mysql/slow.log"
fi
```

#### 8.4.2 每周维护任务

```bash
#!/bin/bash
# weekly_maintenance.sh

# 1. 执行全量备份
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mysql"
mkdir -p $BACKUP_DIR
mysqldump -u root -p$MYSQL_ROOT_PASSWORD --single-transaction --routines --triggers --events health_system > $BACKUP_DIR/full_backup_$DATE.sql
gzip $BACKUP_DIR/full_backup_$DATE.sql

# 2. 优化表
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "OPTIMIZE TABLE health_system.user, health_system.admin, health_system.recipe, health_system.meal_plan;"

# 3. 更新统计信息
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "ANALYZE TABLE health_system.user, health_system.admin, health_system.recipe, health_system.meal_plan;"

# 4. 检查表空间使用情况
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "SELECT table_schema, table_name, ROUND(data_length/1024/1024, 2) as data_size_mb, ROUND(index_length/1024/1024, 2) as index_size_mb FROM information_schema.tables WHERE table_schema = 'health_system';"
```

#### 8.4.3 每月维护任务

```bash
#!/bin/bash
# monthly_maintenance.sh

# 1. 表结构维护(适用于所有表)
# 由于meal_plan表不再使用分区，此步骤已简化
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "SHOW TABLE STATUS FROM health_system LIKE 'meal_plan';"

# 2. 归档历史数据(如果需要)
ARCHIVE_DATE=$(date -d "-6 months" +"%Y-%m-01")

mysql -u root -p$MYSQL_ROOT_PASSWORD -e "CREATE TABLE IF NOT EXISTS health_system.meal_plan_archive LIKE health_system.meal_plan;"
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "INSERT INTO health_system.meal_plan_archive SELECT * FROM health_system.meal_plan WHERE plan_date < '$ARCHIVE_DATE';"
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "DELETE FROM health_system.meal_plan WHERE plan_date < '$ARCHIVE_DATE';"

# 3. 检查数据库配置和参数
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "SHOW VARIABLES;" > /tmp/mysql_variables_$DATE.txt
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "SHOW GLOBAL STATUS;" > /tmp/mysql_status_$DATE.txt

# 4. 检查数据库权限
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "SELECT user, host FROM mysql.user;"
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "SHOW GRANTS FOR 'health_app'@'%';"
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "SHOW GRANTS FOR 'health_admin'@'%';"
```

### 8.5 数据库监控计划

#### 8.5.1 Prometheus + Grafana监控配置

```yaml
# docker-compose.yml配置示例
version: '3'
services:
  mysql:
    image: mysql:8.0
    volumes:
      - mysql_data:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=root_password
    ports:
      - "3306:3306"

  mysql-exporter:
    image: prom/mysqld-exporter
    environment:
      - DATA_SOURCE_NAME=root:root_password@(mysql:3306)/
    ports:
      - "9104:9104"
    depends_on:
      - mysql

  prometheus:
    image: prom/prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus

volumes:
  mysql_data:
```

#### 8.5.2 监控告警配置

```yaml
# prometheus.yml 告警规则
groups:
- name: mysql_alerts
  rules:
  - alert: MySQLHighConnections
    expr: mysql_global_status_threads_connected > 400
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "MySQL连接数过高"
      description: "当前连接数: {{ $value }}, 超过阈值400"

  - alert: MySQLSlowQueries
    expr: rate(mysql_global_status_slow_queries[5m]) > 1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "MySQL慢查询过多"
      description: "5分钟内慢查询数: {{ $value }}"

  - alert: MySQLReplicationLag
    expr: mysql_slave_lag_seconds > 30
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "MySQL主从复制延迟"
      description: "复制延迟: {{ $value }}秒"
```

### 8.6 数据库故障处理

#### 8.6.1 常见故障类型及处理流程

| 故障类型 | 可能原因 | 处理流程 |
| :--- | :--- | :--- |
| 数据库连接失败 | 网络问题、服务未启动、配置错误 | 1. 检查网络连通性<br>2. 确认MySQL服务状态<br>3. 验证用户名密码<br>4. 检查防火墙设置 |
| 查询响应缓慢 | 缺少索引、锁争用、服务器负载高 | 1. 分析慢查询日志<br>2. 检查索引使用情况<br>3. 查看锁状态<br>4. 优化查询语句 |
| 数据库空间不足 | 数据增长过快、未及时清理 | 1. 检查磁盘空间<br>2. 清理无用数据<br>3. 扩展存储空间<br>4. 实施归档策略 |
| 主从复制中断 | 网络问题、数据不一致、配置错误 | 1. 检查复制状态<br>2. 查看错误日志<br>3. 重新配置复制<br>4. 验证数据一致性 |

#### 8.6.2 数据恢复流程

```bash
# 1. 停止应用服务
systemctl stop health-app

# 2. 备份当前数据库(如果可能)
mysqldump -u root -p$MYSQL_ROOT_PASSWORD health_system > /backup/current_before_recovery.sql

# 3. 恢复全量备份
mysql -u root -p$MYSQL_ROOT_PASSWORD health_system < /backup/mysql/full_backup_20240501_000000.sql

# 4. 应用增量备份(如果有)
mysqlbinlog /var/lib/mysql/mysql-bin.000001 --start-position=107 --stop-position=10000 | mysql -u root -p$MYSQL_ROOT_PASSWORD health_system

# 5. 验证数据完整性
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "SELECT COUNT(*) FROM health_system.user;"
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "SELECT COUNT(*) FROM health_system.recipe;"
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "SELECT COUNT(*) FROM health_system.meal_plan;"

# 6. 重启应用服务
systemctl start health-app
```

### 8.7 数据库扩展性规划

#### 8.7.1 容量规划

| 时间点 | 预估数据量 | 存储需求 | 连接数预估 | 扩展建议 |
| :--- | :--- | :--- | :--- | :--- |
| 上线初期 | 1GB | 10GB | 50 | 单机部署 |
| 6个月 | 10GB | 50GB | 200 | 增加内存，优化参数 |
| 1年 | 50GB | 200GB | 400 | 考虑读写分离 |
| 2年 | 200GB | 500GB | 800 | 实施分库分表 |

#### 8.7.2 扩展策略

1. **垂直扩展**
   - 增加服务器CPU、内存、存储
   - 升级到更高性能的存储设备(SSD)
   - 优化数据库参数配置

2. **水平扩展**
   - 读写分离：主库写，从库读
   - 分表：按用户ID或时间范围水平分表
   - 分库：按业务功能垂直分库
   - 考虑使用中间件：ProxySQL、MySQL Router

3. **云服务迁移**
   - 考虑迁移到云数据库服务(如AWS RDS、阿里云RDS)
   - 利用云服务的弹性扩展能力
   - 减少运维成本

### 8.8 文档和知识管理

#### 8.8.1 维护文档清单

| 文档名称 | 维护责任人 | 更新频率 | 存放位置 |
| :--- | :--- | :--- | :--- |
| 数据库设计文档 | 数据库管理员 | 每季度 | 内部文档系统 |
| 操作手册 | 数据库管理员 | 每半年 | 内部文档系统 |
| 故障处理记录 | 数据库管理员 | 每次故障后 | 内部知识库 |
| 性能优化报告 | 数据库管理员 | 每季度 | 内部文档系统 |
| 备份恢复计划 | 数据库管理员 | 每半年 | 内部文档系统 |

#### 8.8.2 知识分享机制

- 每月技术分享会议，讨论数据库优化经验
- 建立内部知识库，记录常见问题和解决方案
- 新员工入职培训，包含数据库相关知识
- 外部技术交流和培训参与

### 8.9 安全审计和合规

#### 8.9.1 定期安全审计

- 每季度进行一次数据库安全扫描
- 每年进行一次第三方安全审计
- 定期检查权限配置和访问控制
- 监控异常登录和操作行为

#### 8.9.2 合规要求

- 遵循相关数据保护法规(如个人信息保护法)
- 确保敏感数据加密存储
- 实施数据访问审计
- 定期进行安全培训

### 8.10 数据库生命周期管理

#### 8.10.1 数据库升级计划

| 版本 | 升级时间 | 升级内容 | 测试计划 |
| :--- | :--- | :--- | :--- |
| MySQL 8.0.30 → 8.0.33 | 2024年Q2 | 安全补丁和性能优化 | 完整回归测试 |
| MySQL 8.0.33 → 8.0.xx | 2024年Q4 | 新功能和性能改进 | 完整回归测试 |

#### 8.10.2 数据库下线流程

1. 提前备份所有数据
2. 通知相关业务方
3. 迁移必要数据到新系统
4. 停止应用访问
5. 确认无数据丢失
6. 执行下线操作

## 9. 附录

### 9.1 参考资料

1. MySQL 8.0 官方文档
2. 《数据库系统概念》(第7版)
3. 健康食谱管理与膳食规划系统需求说明书
4. 个人信息保护法

### 9.2 相关文档

- 健康食谱管理与膳食规划系统需求说明书
- 健康食谱管理与膳食规划系统概要设计文档
- 健康食谱管理与膳食规划系统详细设计文档
- 健康食谱管理与膳食规划系统部署文档
